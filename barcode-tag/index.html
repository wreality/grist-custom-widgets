<html>
    <head>
        <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
        <script src="bcmath-min.js"></script>
        <script src="pdf417-min.js"></script>
        <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
        <style src="https://printjs-4de6.kxcdn.com/print.min.css"></style>
        <style>
            @media print {
                        @page {
                            size: 2.4in 0.8in;
                            orientation: landscape;
                            margin: 0;
                        }

                        #label-root {
                        text-align: center;
                            width: 100%;
                        }
                        #label-bc canvas {
                            width: 100%;
                        }
                        #label-sku {
                            font-size: 0.2in;
                            font-weight: bold;
                        }
                    }
        </style>
    </head>
    <body>
        <div id="label-root">

            <div id="label-bc"></div>
            <div id="label-sku"></div>
        </div>

 <button type="button" onclick="printLabel()">Print</button>
        <script type="text/javascript">
            function printLabel() {
                const style = `
                    @media print {
                        @page {
                            size: 2.4in 0.8in landscape;
                            margin: 0;
                        }

                        #label-root {
                        text-align: center;
                            width: 100%;
                        }
                        #label-bc canvas {
                            width: 100%;
                            height: 0.5in;
                        }
                        #label-sku {
                            font-size: 0.2in;
                            font-weight: bold;
                        }
                    }
                `;
                printJS({ printable: 'label-root', type: 'html', style});
            }
            grist.ready({
                columns: ['SKU'],
                requiredAccess: 'read table'
            });

            grist.onRecord(parseRecord)



            function parseRecord(record) {
                const { SKU } = grist.mapColumnNames(record);
                generateBarcode(SKU)
            }

            generateBarcode('GRIST-ATTEMPT-12345');

            function generateBarcode(SKU) {
                const label = document.getElementById('label-bc');
                const labelSku = document.getElementById('label-sku');
                label.innerHTML = "";
                labelSku.innerHTML = SKU;
                PDF417.init(SKU);
                var barcode = PDF417.getBarcodeArray();

                var bw = 2, bh =2;

                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                canvas.width = bw * barcode['num_cols'];
                canvas.height = bh * barcode['num_rows'];
                label.appendChild(canvas);
                var y = 0;
                for (var r =0; r < barcode['num_rows']; ++r) {
                    var x = 0;
                    for (var c = 0; c < barcode['num_cols']; ++c) {
                        if (barcode['bcode'][r][c] == 1) {
                            ctx.fillRect(x, y, bw, bh);
                        }
                        x += bw;
                    }
                    y += bh;
                }
            }
        </script>
    </body>
</html>
